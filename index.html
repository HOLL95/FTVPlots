<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fourier Transform Voltammetry Processing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="filehandling.js"></script>
    <script src="web_elements.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 100vw; margin: 0 auto; padding: 20px;   }
        /*canvas { width: 100% !important; height: 400px !important; margin-bottom: 20px; }
        .slider-container { display: flex; align-items: center; margin-bottom: 10px; }
        .slider-container label { width: 20px; margin-right: 10px; }
        .slider-container input { flex-grow: 1; }
        .slider-container span { width: 50px; text-align: right; }
        #fileInput { margin-bottom: 10px; }
        #processResult { margin-top: 20px; }*/
        .dropdown-container {
            display: flex;
            gap: 10px; /* Space between the dropdowns */
        }
        .range_container {
        display: flex;
        flex-direction: column;
        width: 20%;
        margin-left: 0%;
        }
        .global-options-container{

             border: 2px solid #0f0f0f; /* Individual border around each panel */
            border-radius: 5px; /* Optional: rounded corners */
            padding: 10px;
        }
        #file-panels {
            width: 30%; /* Panels take up 30% of the screen width */
            max-height: 80vh; /* Limit the height to avoid overflow  overflow-y: auto; /* Scroll if the content exceeds the height */
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: absolute; /* Positioning to left-align */
            left: 20px; /* Distance from the left edge of the screen */
            top: 360px; /* Distance from the top of the screen */
        }
        .panel {
            border: 2px solid #050505; /* Individual border around each panel */
            border-radius: 5px; /* Optional: rounded corners */
            padding: 10px;
            background-color: #f9f9f9;
        }
        .panel-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .panel-content {
            margin-top: 10px;
        }

        .add-file-btn {
            margin: 20px 0;
        }

        .file-container {
            margin: 20px 0;
        }

        .toggle-file-inputs {
            margin-bottom: 10px;
        }
        .sliders_control {
        position: relative;
        min-height: 25px;
        margin-top:20px;
        }

        .form_control {
        position: relative;
        display: flex;
        justify-content: space-between;
        font-size: 16px;

        }

        input[type=range]::-webkit-slider-thumb {
        pointer-events: all;
        width: 12px;
        height: 12px;
        cursor: pointer;
        }

        input[type=range]::-moz-range-thumb {
        pointer-events: all;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        box-shadow: 0 0 0 1px #050505;
        cursor: pointer;  
        }

        input[type="number"] {
        width: 40px;
        height: 25px;
        font-size: 16px;
        border: none;
        }
        

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {  
        opacity: 1;
        }

        input[type="range"] {
        height: 2px;
        width: 100%;
        position: absolute;
        background-color: #070707;
        pointer-events: none;
        }

        #fromSlider {
        height: 0;
        z-index: 1;
        }
        .plot-btn {
            background-color: #d41c1c; /* Green */
            border: none;
            color: white;
            padding: 25px 22px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-size: 18px;
            }
            .add-file-btn {
            background-color: #7726c4; /* Green */
            border: none;
            color: white;
            padding: 25px 22px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-size: 18px;
            }
            .plotsave-btn {
            background-color: #7726c4; /* Green */
            border: none;
            color: white;
            padding: 25px 22px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-size: 18px;
            }
            .tocsv-btn {
            background-color: #7726c4; /* Green */
            border: none;
            color: white;
            padding: 25px 22px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-size: 18px;
            }
           /* Right panel (70% of the screen width) */
      
        .left-panel {
            width: 30%;
            padding-right: 20px;
        }

        .right-panel {
            width: 70%;
        }

        #graphs-container {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
        }
        .graph-container {
            box-sizing: border-box;
            padding: 20px 60px 40px 20px;
            margin-bottom: 20px;
        }
        .graph-container.half-width {
            width: 50%;
            height: 400px !important;
            padding: 20px 60px 40px 20px;
        }
        .graph-container.full-width {
            width: 100%;
            height: 400px !important;
            padding: 20px 60px 40px 20px;
        }
        .main-container {
            display: flex;
            width: 100%;
            margin-top: 20px;
        }
       
        #loadingIndicator {
        display: none;
        margin-left: 10px;
        font-style: italic;
        }
        .spinner {
            /* ... spinner styles ... */
        }
    </style>
</head>
<body>
    <h1>Fourier Transform Voltammetry Processing</h1>
    <div class="global-options-container">
    <div class="dropdown-container", id="ddown">
        <label for="experiment">Experiment:</label>
        <select id="experiment" >
            <option value="FTACV" selected>FTACV</option>
            <option value="PSV">PSV</option>
        </select>
        <label for="xaxis">X-axis:</label>
        <select id="xaxis" onchange="updateParameters()">
            <option value="Time">Time</option>
            <option value="Potential">Potential</option>
            <option value="DC_Potential">DC Potential</option>
        </select>
        <label for="powerspectrum">Magnitude spectrum:</label>
            
    <select id="powerspectrum">
        <option value="normal">Normal</option>
        <option value="logarithmic">Logarithmic</option>
    </select>
        <label for="currentscaling">Current Scaling:</label>
        <select id="currentscaling">
            <option value="None">Amps</option>
            <option value="milli">Milliamps</option>
            <option value="micro" selected>Microamps</option>
            <option value="nano">Nanoamps</option>
        </select>
        <label for="potentialscaling">Potential scaling:</label>
        <select id="potentialscaling">
            <option value="None">Volts</option>
            <option value="milli" selected>Millivolts</option>
        </select>
        <label for="harmonictype">Harmonic plot:</label>
        <select id="harmonictype">
            <option value="envelope">Envelope</option>
            <option value="total">Total</option>
        </select>
        <label for="hanning">Apply Hanning window</label><br>
        <input type="checkbox" id="hanning" name="Hanning" value="Hanning">
        <label for="csvcheckbox">Enable saving</label><br>
        <input type="checkbox" id="csvcheckbox" name="CSVcheck" onchange="savecsvbutton()">
        
    </div>
    <div class="range_container">
        <div class="sliders_control">
            <input id="fromSlider" type="range" value="0" min="0" max="16"/>
            <input id="toSlider" type="range" value="10" min="1" max="16"/>
        </div>
        <div class="form_control">
            <div class="form_control_container">
                <div class="form_control_container__time">Lowest harmonic</div>
                <input class="form_control_container__time__input" type="number" id="fromInput" value="0" min="0" max="16"/>
            </div>
            <div class="form_control_container">
                <div class="form_control_container__time">Highest harmonic</div>
                <input class="form_control_container__time__input" type="number" id="toInput" value="10" min="1" max="16"/>
            </div>
        </div>
    </div>
</div>
<div class="main-container">
    <div class="left-panel">
        <button class="add-file-btn" onclick="addFilePanel()">Add File</button>
        <button class ="plot-btn" onclick="plot()">PLOT</button>
        <button class ="plotsave-btn", id="plotsave", onclick="saveallplot()">Save plots</button>
        <button class ="tocsv-btn", id="csvsave", onclick="savecsv()">Save data</button>
        <div id="file-panels"></div>
    
    </div>  
    <div class="right-panel">

        <div id="graphs-container"></div>
    </div>
</div>

</body>
   

   
</body>
<script>
    var datastore=[];
    var plotstore=[];
    var filesStorage=[]
    let panelCount = 0;
    const maxPanels = 5; // Maximum number of panels allowed
    const textboxesConfig = {
        'DC_Potential': ["Frequency (Hz)", "Amplitude (mV)",'Start potential (V)', 'Switch potential (V)', 'Scan rate (V s<sup>-1</sup>)' ],
        'Time': ["Frequency (Hz)", "Amplitude (mV)"],
        "Potential":["Frequency (Hz)", "Amplitude (mV)"]
        
    };
    
    const labeldict={"Frequency (Hz)":"freq", "Amplitude (mV)":"amp",'Start potential (V)':"estart", 'Switch potential (V)':"ereverse", 'Scan rate (V s<sup>-1</sup>)':"v"}
    const invlabeldict=Object.entries(labeldict).reduce((reversedObj, [key, value]) => {
        reversedObj[value] = key;
        return reversedObj;
    }, {});
    
    const fromSlider = document.querySelector('#fromSlider');
    const toSlider = document.querySelector('#toSlider');
    const fromInput = document.querySelector('#fromInput');
    const toInput = document.querySelector('#toInput');
    fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider);
    setToggleAccessible(toSlider);

    fromSlider.oninput = () => controlFromSlider(fromSlider, toSlider, fromInput);
    toSlider.oninput = () => controlToSlider(fromSlider, toSlider, toInput);
    fromInput.oninput = () => controlFromInput(fromSlider, fromInput, toInput, toSlider);
    toInput.oninput = () => controlToInput(toSlider, fromInput, toInput, toSlider);
    // Initialize the global options when the DOM is fully loaded
    function savecsvbutton(){
        const csvbox=document.getElementById("csvcheckbox")
        const csvbutton=document.getElementById("csvsave")
        if (csvbox.checked===true){
            plot()
            csvbutton.style.visibility="visible";
            
            
        }
        else{
            csvbutton.style.visibility="hidden";
        }
            
    }
    function updateParameters() {
        const xaxis = document.getElementById('xaxis').value;
        const options = textboxesConfig[xaxis] || [];
        if (xaxis==="DC_Potential"){
            if (document.getElementById("ShowDC")===null){
                const ddown=document.getElementById("ddown");
                const label = document.createElement('label');
                label.innerHTML = "Plot DC potential";
                label.id="ShowDCLabel"
                const box = document.createElement('input');
                box.type="checkbox";
                box.id="ShowDC"
                box.checked=true;
                ddown.appendChild(label);
                ddown.appendChild(box);
            }
           
        }else{

            const elem=document.getElementById("ShowDC")
            if (elem!=null){
                elem.remove();
                document.getElementById("ShowDCLabel").remove();

            }
        }
        
        // Update existing panels with new textboxes
        const panels = document.querySelectorAll('#file-panels .panel');
        panels.forEach((panel, panelIndex) => {
            const textboxesContainer = panel.querySelector('.textboxes-container');
            textboxesContainer.innerHTML = ''; // Clear existing textboxes

            options.forEach((textboxLabel) => {
            const label = document.createElement('label');
            label.innerHTML = textboxLabel;

            const input = document.createElement('input');
            input.type = 'text';
            input.style.width = '40px';
            input.style.marginBottom = '10px';
            input.style.marginRight = '5px';
            input.style.marginLeft = '5px';

            // Assign a unique ID to the input
            input.id = `panel-${panelIndex + 1}-textbox-${labeldict[textboxLabel]}`;
            textboxesContainer.appendChild(label);
            textboxesContainer.appendChild(input);
            });
        });
    }
document.addEventListener('DOMContentLoaded', function() {
            const xaxis = document.getElementById('xaxis');
    
            // Set default value
            xaxis.value = 'Time';
            updateParameters();
            savecsvbutton();
        });      
       
    

</script>


<script type="module">
 
import init, * as wasm from './biquad_wasm/pkg/biquad_wasm.js';


   
window.plot =async function plot(event){
    console.time("plotting")
    datastore=[];
    plotstore=[];
    await init('./biquad_wasm/pkg/biquad_wasm_bg.wasm');

    const values = {};
    // Create the first two side-by-side plots (first row)
    
    
    // Get values from dropdowns
    values.experiment = document.getElementById('experiment').value;
    values.xaxis = document.getElementById('xaxis').value;
    values.powerspectrum = document.getElementById('powerspectrum').value;
    values.currentscaling = document.getElementById('currentscaling').value;
    values.potentialscaling = document.getElementById('potentialscaling').value;
    const scaledict={"None":1, "milli":1e3, "micro":1e6, "nano":1e9};
    const scaleunitdict={"None":"", "milli":"m", "micro":"μ", "nano":"n"}
    values.harmonictype = document.getElementById('harmonictype').value;

    // Get value from checkbox
    values.hanning = document.getElementById('hanning').checked; // returns true or false

    // Get values from sliders and number inputs
    values.lowestharm = parseInt(document.getElementById('fromSlider').value);
    values.highestharm = parseInt(document.getElementById('toSlider').value)+1;
    const num_harmonics=values.highestharm-values.lowestharm;
    const num_experiments=Number(panelCount);
    const container = document.getElementById('graphs-container');
    container.innerHTML = '';
    for (let i=0;i<2; i++){
        const graphDiv = document.createElement('div');
        graphDiv.id = `graph${i}`;
        graphDiv.className = 'graph-container half-width';
        container.appendChild(graphDiv);
    }
    for (let i=2;i<(2+(values.highestharm-values.lowestharm)+1); i++){
        const graphDiv = document.createElement('div');
        graphDiv.id = `graph${i}`;
        graphDiv.className = 'graph-container full-width';
        container.appendChild(graphDiv);
    }
    const lastgraph=2+(values.highestharm-values.lowestharm);

    if (num_experiments==0){
        return;
    }
    const plot_object={}
    const dropdowns=["Time", "Current", "Potential"];
    var key;
    var getid;
    
    var data_array=[];
    var harmonic_array=[];
    var FT_array=[];
    for (let i = 0; i < num_experiments; i++) {
        var fileIndex = filesStorage.findIndex(file => file["experiment"] === i+1);
        if (fileIndex==-1){
            continue;
        }
        key=i+1;
        plot_object[key]={};
       
        var xy;
        if (filesStorage[fileIndex].hasOwnProperty("Column 1" )) {
            var existingid=[];
            for (let j=0; j<3; j++){
                getid=document.getElementById(`column-${dropdowns[j]}-${i+1}`).value;
                if (existingid.includes(getid)){
                    alert(`${getid} assigned to two variables`)
                    return;
                }
                existingid.push(getid)
                plot_object[key][dropdowns[j].toLowerCase()]=filesStorage[fileIndex][getid]
            }
            
        }else{
            for (let j=0; j<3; j++){
                if (filesStorage[fileIndex].hasOwnProperty(dropdowns[j].toLowerCase())){
                    plot_object[key][dropdowns[j].toLowerCase()]=filesStorage[fileIndex][dropdowns[j].toLowerCase()]
                }else if ((filesStorage[fileIndex].hasOwnProperty("voltage")) && (dropdowns[j]==="Potential")){
                    plot_object[key]["potential"]=filesStorage[fileIndex]["voltage"]
                }
                else{
                    alert(`Missing ${dropdowns[j]} data`)
                    return;
                }

            }
        }
        
        var dec=document.getElementById(`decimation-${i+1}`).value;
        if ( dec=== "" || isNaN(parseInt(dec))){
            document.getElementById(`decimation-${i+1}`).value=15;
            plot_object[key]["decimation"]=15;
        }else{
            plot_object[key]["decimation"]=Math.abs(parseInt(dec));
            document.getElementById(`decimation-${i+1}`).value= plot_object[key]["decimation"];
        }
        var label=document.getElementById(`label-${i+1}`).value;
        if (label===""){
            document.getElementById(`label-${i+1}`).value=`Exp ${i+1}`;
            plot_object[key]["label"]=`Exp ${i+1}`
        }else{
            plot_object[key]["label"]=label
        }
        plot_object[key]["colour"]=document.getElementById(`colourPicker-${i + 1}`).value;
        var filter=document.getElementById(`filter-${i+1}`).value;
        if ( filter=== "" || isNaN(parseInt(filter))){
            document.getElementById(`filter-${i+1}`).value=100;
            plot_object[key]["filter"]=100;
        }else{
            plot_object[key]["filter"]=Math.min(100,Math.abs(parseInt(filter)));
            document.getElementById(`filter-${i+1}`).value=plot_object[key]["filter"]
        }
        var user_freq=document.getElementById(`panel-${key}-textbox-freq`).value;
        var write_frequency =false;
        if (isNaN(parseFloat(user_freq))){
            user_freq=0;
            write_frequency=true;
        }
        else{
            user_freq=parseFloat(user_freq);
        }
        var curr_array=plot_object[key]["current"].map(element => element * scaledict[values.currentscaling])
        var pot_array=plot_object[key]["potential"].map(element => element * scaledict[values.potentialscaling])
        var dcvalues={};
        const sample_rate=1/(plot_object[key]["time"][1]-plot_object[key]["time"][0]);
        var x;
        for (let i=0; i<curr_array.length; i++){
            x=parseFloat(curr_array[i])
            if (isNaN(x)){
                curr_array.splice(i, 1);
                pot_array.splice(i, 1);
                plot_object[key]["time"].splice(i, 1);
            }
        }
        const rust_objects=wasm.harmonics(plot_object[key]["time"],
                                            curr_array,
                                            user_freq,
                                            values.harmonictype==="envelope",
                                            values.hanning,
                                            Array.from({ length: num_harmonics}, (_, index) => values.lowestharm + index),
                                            plot_object[key]["filter"],
                                            plot_object[key]["decimation"],
                                            sample_rate,
                                            );
        

        if (write_frequency===true){
            document.getElementById(`panel-${key}-textbox-freq`).value=Math.round(rust_objects.dominantFrequency * 100) / 100;            
        }
        const xyz=wasm.decimate_data(plot_object[key]["time"], 
                        curr_array, 
                        pot_array,
                        plot_object[key]["decimation"],
                        sample_rate, 
                        rust_objects.dominantFrequency*(values.highestharm+2));
        var data_object={"Time":xyz[0], "current":xyz[1], "Potential":xyz[2]}
        
        data_array.push(data_object)
        const freq=rust_objects.dominantFrequency
        const amp=1e3*wasm.get_amplitude(plot_object[key]["potential"], plot_object[key]["time"][1]-plot_object[key]["time"][0], freq)
        
        var voltage_params={};
        voltage_params["estart"]=calculateMean(plot_object[key]["potential"].slice(0, findClosestIndex(plot_object[key]["time"], 2/freq )))
        const midpoint=plot_object[key]["time"][parseInt(plot_object[key]["time"].length/2)]

        voltage_params["ereverse"]=calculateMean(plot_object[key]["potential"].slice(findClosestIndex(plot_object[key]["time"], midpoint-(1/freq) ), findClosestIndex(plot_object[key]["time"], midpoint+(1/freq) )))
        voltage_params["v"]=voltage_params["ereverse"]-voltage_params["estart"]/midpoint
        if (document.getElementById("xaxis").value==="DC_Potential"){
            const necessary_keys=["estart", "ereverse", "v"]
            
            for (let i=0; i<necessary_keys.length; i++){
                dcvalues[necessary_keys[i]]=parseFloat(document.getElementById(`panel-${key}-textbox-${necessary_keys[i]}`).value)
                if (isNaN(dcvalues[necessary_keys[i]])){
                    document.getElementById(`panel-${key}-textbox-${necessary_keys[i]}`).value=voltage_params[necessary_keys[i]];
                    dcvalues[necessary_keys[i]]=voltage_params[necessary_keys[i]];
                    
                }
            }
            const dcaxes=wasm.dc_potential(xyz[0], dcvalues["estart"], dcvalues["ereverse"], dcvalues["v"]).map(x => x*scaledict[values.potentialscaling]);
            data_object["DC_Potential"]=dcaxes;

        }
        document.getElementById(`panel-${key}-textbox-amp`).value=Math.round((amp) * 10) / 10;   
        
        rust_objects.harmonics[0]=[...data_object[document.getElementById("xaxis").value]];
        harmonic_array.push(rust_objects.harmonics);
        FT_array.push({"freqs":rust_objects.fftFreqs, "mags":rust_objects.fftMagnitudes})
        var savelement={title:plot_object[key]["label"], data:{}};
        if (document.getElementById("csvcheckbox").checked===true){
            
            savelement["data"]["Time (s)"]=data_object.Time
            savelement["data"][`Current (${scaleunitdict[values.currentscaling]}A)`]=data_object.current
            
            savelement["data"][`Potential (${scaleunitdict[values.potentialscaling]}V)`]=data_object.Potential
            if (data_object.hasOwnProperty("DC_Potential")){
                savelement["data"][`DC Potential (${scaleunitdict[values.potentialscaling]}V)`]=data_object.DC_Potential
            }
            for (let i=0; i<num_harmonics; i++){
                savelement["data"][`Harmonic ${values.lowestharm+i} (${scaleunitdict[values.currentscaling]}A)`]=rust_objects.harmonics[i+1];
            }
            datastore.push(savelement)
        }
        
  
    }
    
    var harmonic_plot;
    const xaxis_dict={"Time":"Time (s)", "Potential":`Potential (${scaleunitdict[values.potentialscaling]}V)`, "DC_Potential":`DC potential (${scaleunitdict[values.potentialscaling]}V)`}
    if (document.getElementById("xaxis").value==="DC_Potential"){
        var harm_plot_opts={
            drawPoints: false,
            legend:"always",
            showRoller: false,
            xlabel: xaxis_dict[document.getElementById("xaxis").value],
            ylabel: `Current (${scaleunitdict[values.currentscaling]}A)`,
            connectSeparatedPoints:false,
            drawPoints:true,
            strokeWidth:0.0}
        }else{
            var harm_plot_opts={
            drawPoints: false,
            legend:"always",
            showRoller: false,
            xlabel: xaxis_dict[document.getElementById("xaxis").value],
            ylabel: `Current (${scaleunitdict[values.currentscaling]}A)`,
            connectSeparatedPoints:true,
            strokeWidth:2}
        }
    var pot_plot_opts={title: `Time-Potential`,
            drawPoints: false,
            showRoller: false,
            xlabel: 'Time (s)',
            ylabel: `Potential (${scaleunitdict[values.potentialscaling]}V)`,
            connectSeparatedPoints:true}
    var cur_plot_opts={
            title: `${values["xaxis"]}-Current`,
            drawPoints: false,
            legend:"always",
            showRoller: false,
            xlabel: xaxis_dict[document.getElementById("xaxis").value],
            ylabel: `Current (${scaleunitdict[values.currentscaling]}A)`,
            connectSeparatedPoints:true,
        };
    var FT_plot_opts={title: `Magnitude spectrum`,
        drawPoints: false,
        showRoller: false,
        xlabel: 'Frequencies (Hz)',
        ylabel: `Magnitude`,
        connectSeparatedPoints:true}
    if (document.getElementById("powerspectrum").value==="logarithmic"){
        FT_plot_opts["logscale"]=true;
    }
    var pot_plot_key;
    if (document.getElementById("ShowDC")!= null && document.getElementById("ShowDC").checked===true){
        pot_plot_key="DC_Potential";
        pot_plot_opts["strokeWidth"]=2;
    }
    else{
        pot_plot_key="Potential";
    }
    
    const potential_plot = mergeSeriesForDygraphs(
                                        data_array.map(dec_exp => {
                                                return columnStackObject(dec_exp, ["Time",pot_plot_key]);
                                            })
                                        );
    
    const current_plot=mergeSeriesForDygraphs(
                                        data_array.map(dec_exp => {
                                                return columnStackObject(dec_exp, [document.getElementById("xaxis").value, "current"]);
                                            })
                                        );
    
    const FT_plot=mergeSeriesForDygraphs(
                                        FT_array.map(dec_exp => {
                                                return columnStackObject(dec_exp, ["freqs", "mags"]);
                                            })
                                        );
   
    const colours=[];
    const labels=[];
    for (var key in plot_object){
        
        if(plot_object.hasOwnProperty(key)){
            colours.push(plot_object[key]["colour"])
            labels.push(plot_object[key]["label"])
        }
    }

   
    if (data_array.length==1){
        pot_plot_opts["color"]=colours[0]
        cur_plot_opts["color"]=colours[0]
        pot_plot_opts["labels"]=["Time"].concat(labels);
        cur_plot_opts["labels"]=["Time"].concat(labels);
        FT_plot_opts["color"]=colours[0]
        FT_plot_opts["labels"]=["Frequency"].concat(labels);
    }else{
        cur_plot_opts["colors"]=colours;
        pot_plot_opts["colors"]=colours;
        
        pot_plot_opts["labels"]=["Time"].concat(labels);
        cur_plot_opts["labels"]=["Time"].concat(labels);
        FT_plot_opts["colors"]=colours;
        FT_plot_opts["labels"]=["Frequency"].concat(labels);
    }
    const pp=new Dygraph(document.getElementById("graph0"), 
    potential_plot,pot_plot_opts
    );
    const cp=new Dygraph(document.getElementById("graph1"), 
    current_plot, cur_plot_opts
    );
    const fp=new Dygraph(document.getElementById(`graph${num_harmonics+2}`), 
    FT_plot, FT_plot_opts,
    );
    plotstore.push(fp)
    plotstore.push(pp)
    plotstore.push(cp)
    
    for (let i=1; i<num_harmonics+1; i++){
        
        harmonic_plot=mergeSeriesForDygraphs(
                                        harmonic_array.map(harmonic_exp => {
                                                return columnStack(harmonic_exp, [0, i]);
                                            })
                                        );
        
        harm_plot_opts["title"]=`Harmonic ${values.lowestharm+(i-1)}`;
        if (data_array.length==1){
            harm_plot_opts["color"]=colours[0]
            harm_plot_opts["labels"]=["Time"].concat(labels);
            
        }else{
            harm_plot_opts["colors"]=colours;
            harm_plot_opts["labels"]=["Time"].concat(labels);
        }
        const hp=new Dygraph(document.getElementById(`graph${i+1}`), 
            harmonic_plot,harm_plot_opts
            );
        plotstore.push(hp)
    }
    
    return values;
}


window.saveallplot=async function saveallplot(event){
    const savebtn= document.getElementById('plotsave');
    savebtn.disabled = true;
    const zip = new JSZip();
    if (plotstore.length===0){
        return;
    }
    const promises = plotstore.map((graph, index) => 
                html2canvas(document.getElementById(`graph${index}`),
                {
                    logging: false,
                    height: 400
                }
            
                ).then(canvas => {
                    return new Promise(resolve => {
                        canvas.toBlob(blob => {
                            const title = graph.getOption('title');
                            const filename = sanitizeFilename(title) + '.png';
                            zip.file(filename, blob);
                            resolve();
                        });
                    });
                })
            );

    await Promise.all(promises);

    zip.generateAsync({type:"blob"}).then(function(content) {
        const link = document.createElement('a');
        link.download = 'graphs.zip';
        link.href = URL.createObjectURL(content);
        link.click();
        savebtn.disabled = false;

    });
}
window.savecsv=async function savecsv(event) {
    const savebtn=document.getElementById("csvsave");
    savebtn.disabled=true;
    if (datastore.length===0){
        return;
    }
    const zip = new JSZip();

    datastore.forEach((obj, index) => {
    const csvContent = objectToCSV(obj["data"]);
    zip.file(`${obj["title"]}.csv`, csvContent);
    });

    const content = await zip.generateAsync({ type: "blob" });

    const link = document.createElement('a');
    link.href = URL.createObjectURL(content);
    link.download = 'data.zip';
    link.click();
    URL.revokeObjectURL(link.href);
    savebtn.disabled=false;
}
    
        


function sanitizeFilename(name) {
        return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
}
function columnStack(array, index) {
    // Find the length of the first array (assumes all arrays are the same length)
    const rows = array[0].length;
    const col_num=2;
    const result = [];

    // Iterate over each row index
    for (let i = 0; i < rows; i++) {
        const row = [];

        // Collect the ith element from each array
        for (let j=0; j<col_num; j++) {
            row.push(array[index[j]][i]);
        }
        result.push(row);
    }

    return result;
}
function findClosestIndex(arr, target) {
    if (arr.length === 0) {
        return -1; // Return -1 if the array is empty
    }

    return arr.reduce((closest, current, index) => {
        if (Math.abs(current - target) < Math.abs(arr[closest] - target)) {
            return index;
        } else {
            return closest;
        }
    }, 0);
}
function calculateMean(numbers) {
    if (numbers.length === 0) {
        return 0; // or you might want to return null or throw an error
    }
    
    const sum = numbers.reduce((acc, val) => acc + val, 0);
    return sum / numbers.length;
}
function columnStackObject(object, keys) {
    // Find the length of the first array (assumes all arrays are the same length)
    const rows = object[Object.keys(object)[0]].length;
    const col_num=2;
    const result = [];

    // Iterate over each row index
    for (let i = 0; i < rows; i++) {
        const row = [];

        // Collect the ith element from each array
        for (let j=0; j<col_num; j++) {
            row.push(object[keys[j]][i]);
        }
        result.push(row);
    }

    return result;
}

function mergeSeriesForDygraphs(seriesArray) {
    // Step 1: Collect all unique x-values
    const xValues = new Set();
    seriesArray.forEach(series => {
        series.forEach(point => xValues.add(point[0]));
    });

    // Step 2: Create a sorted array of unique x-values
    const sortedXValues = Array.from(xValues).sort((a, b) => a - b);

    // Step 3: Create a map for quick lookup of y-values
    const mapped_arrays=seriesArray.map(series => mapFuncCols(series));

    // Step 4: Merge the series
    const mergedData = sortedXValues.map(x => {
        const row = [x];
        mapped_arrays.forEach(seriesMap => {
            row.push(seriesMap[x] ?? null);
        });
        return row;
    });
    return mergedData;
}
function mapFuncCols(colstacked_array) {
  const result = {};
  for (let i = 0; i < colstacked_array.length; i++) {
    result[colstacked_array[i][0]] = colstacked_array[i][1];
  }
  
  return result;
}
function objectToCSV(obj) {
  const headers = Object.keys(obj);
  const maxLength = Math.max(...headers.map(header => obj[header].length));
  
  const csvRows = [headers.join(',')];
  
  for (let i = 0; i < maxLength; i++) {
    const row = headers.map(header => {
      const value = obj[header][i];
      return value !== undefined ? value : '';
    }).join(',');
    csvRows.push(row);
  }

  return csvRows.join('\n');
}
</script>
</html>
