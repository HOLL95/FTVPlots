<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fourier Transform Voltammetry Processing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="filehandling.js"></script>
    <script src="web_elements.js"></script>
    <script src="plot_and_save.js"></script>
    <script src="utils.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 100vw; margin: 0 auto; padding: 20px;   }
        /*canvas { width: 100% !important; height: 400px !important; margin-bottom: 20px; }
        .slider-container { display: flex; align-items: center; margin-bottom: 10px; }
        .slider-container label { width: 20px; margin-right: 10px; }
        .slider-container input { flex-grow: 1; }
        .slider-container span { width: 50px; text-align: right; }
        #fileInput { margin-bottom: 10px; }
        #processResult { margin-top: 20px; }*/
        .dropdown-container {
            display: flex;
            gap: 10px; /* Space between the dropdowns */
        }
        .range_container {
        display: flex;
        flex-direction: column;
        width: 20%;
        margin-left: 0%;
        }
        .global-options-container{

             border: 2px solid #0f0f0f; /* Individual border around each panel */
            border-radius: 5px; /* Optional: rounded corners */
            padding: 10px;
        }
        #file-panels {
            width: 30%; /* Panels take up 30% of the screen width */
            max-height: 80vh; /* Limit the height to avoid overflow  overflow-y: auto; /* Scroll if the content exceeds the height */
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: absolute; /* Positioning to left-align */
            left: 20px; /* Distance from the left edge of the screen */
            top: 360px; /* Distance from the top of the screen */
        }
        .panel {
            border: 2px solid #050505; /* Individual border around each panel */
            border-radius: 5px; /* Optional: rounded corners */
            padding: 10px;
            background-color: #f9f9f9;
        }
        .panel-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .panel-content {
            margin-top: 10px;
        }

        .add-file-btn {
            margin: 20px 0;
        }

        .file-container {
            margin: 20px 0;
        }

        .toggle-file-inputs {
            margin-bottom: 10px;
        }
        .sliders_control {
        position: relative;
        min-height: 25px;
        margin-top:20px;
        }

        .form_control {
        position: relative;
        display: flex;
        justify-content: space-between;
        font-size: 16px;

        }

        input[type=range]::-webkit-slider-thumb {
        pointer-events: all;
        width: 12px;
        height: 12px;
        cursor: pointer;
        }

        input[type=range]::-moz-range-thumb {
        pointer-events: all;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        box-shadow: 0 0 0 1px #050505;
        cursor: pointer;  
        }

        input[type="number"] {
        width: 40px;
        height: 25px;
        font-size: 16px;
        border: none;
        }
        

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {  
        opacity: 1;
        }

        input[type="range"] {
        height: 2px;
        width: 100%;
        position: absolute;
        background-color: #070707;
        pointer-events: none;
        }

        #fromSlider {
        height: 0;
        z-index: 1;
        }
        .plot-btn {
            background-color: #d41c1c; /* Green */
            border: none;
            color: white;
            padding: 25px 22px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-size: 18px;
            }
            .add-file-btn {
            background-color: #7726c4; /* Green */
            border: none;
            color: white;
            padding: 25px 22px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-size: 18px;
            }
            .plotsave-btn {
            background-color: #7726c4; /* Green */
            border: none;
            color: white;
            padding: 25px 22px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-size: 18px;
            }
            .tocsv-btn {
            background-color: #7726c4; /* Green */
            border: none;
            color: white;
            padding: 25px 22px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-size: 18px;
            }
           /* Right panel (70% of the screen width) */
      
        .left-panel {
            width: 30%;
            padding-right: 20px;
        }

        .right-panel {
            width: 70%;
        }

        #graphs-container {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
        }
        .graph-container {
            box-sizing: border-box;
            padding: 20px 60px 40px 20px;
            margin-bottom: 20px;
        }
        .graph-container.half-width {
            width: 50%;
            height: 400px !important;
            padding: 20px 60px 40px 20px;
        }
        .graph-container.full-width {
            width: 100%;
            height: 400px !important;
            padding: 20px 60px 40px 20px;
        }
        .main-container {
            display: flex;
            width: 100%;
            margin-top: 20px;
        }
       
        #loadingIndicator {
        display: none;
        margin-left: 10px;
        font-style: italic;
        }
        .spinner {
            /* ... spinner styles ... */
        }
    </style>
</head>
<body>
    <h1>Fourier Transform Voltammetry Processing</h1>
    <div class="global-options-container">
    <div class="dropdown-container", id="ddown">
        <label for="experiment">Experiment:</label>
        <select id="experiment" >
            <option value="FTACV" selected>FTACV</option>
            <option value="PSV">PSV</option>
        </select>
        <label for="xaxis">X-axis:</label>
        <select id="xaxis" onchange="updateParameters()">
            <option value="Time">Time</option>
            <option value="Potential">Potential</option>
            <option value="DC_Potential">DC Potential</option>
        </select>
        <label for="powerspectrum">Magnitude spectrum:</label>
            
    <select id="powerspectrum">
        <option value="normal">Normal</option>
        <option value="logarithmic">Logarithmic</option>
    </select>
        <label for="currentscaling">Current Scaling:</label>
        <select id="currentscaling">
            <option value="None">Amps</option>
            <option value="milli">Milliamps</option>
            <option value="micro" selected>Microamps</option>
            <option value="nano">Nanoamps</option>
        </select>
        <label for="potentialscaling">Potential scaling:</label>
        <select id="potentialscaling">
            <option value="None">Volts</option>
            <option value="milli" selected>Millivolts</option>
        </select>
        <label for="harmonictype">Harmonic plot:</label>
        <select id="harmonictype">
            <option value="envelope">Envelope</option>
            <option value="total">Total</option>
        </select>
        <label for="hanning">Apply Hanning window</label><br>
        <input type="checkbox" id="hanning" name="Hanning" value="Hanning">
        <label for="csvcheckbox">Enable saving</label><br>
        <input type="checkbox" id="csvcheckbox" name="CSVcheck" onchange="savecsvbutton()">
        
    </div>
    <div class="range_container">
        <div class="sliders_control">
            <input id="fromSlider" type="range" value="0" min="0" max="16"/>
            <input id="toSlider" type="range" value="10" min="1" max="16"/>
        </div>
        <div class="form_control">
            <div class="form_control_container">
                <div class="form_control_container__time">Lowest harmonic</div>
                <input class="form_control_container__time__input" type="number" id="fromInput" value="0" min="0" max="16"/>
            </div>
            <div class="form_control_container">
                <div class="form_control_container__time">Highest harmonic</div>
                <input class="form_control_container__time__input" type="number" id="toInput" value="10" min="1" max="16"/>
            </div>
        </div>
    </div>
</div>
<div class="main-container">
    <div class="left-panel">
        <button class="add-file-btn" onclick="addFilePanel()">Add File</button>
        <button class ="plot-btn" onclick="plot()">PLOT</button>
        <button class ="plotsave-btn", id="plotsave", onclick="saveallplot()">Save plots</button>
        <button class ="tocsv-btn", id="csvsave", onclick="savecsv()">Save data</button>
        <div id="file-panels"></div>
    
    </div>  
    <div class="right-panel">

        <div id="graphs-container"></div>
    </div>
</div>

</body>
   

   
</body>
<script>
    var datastore=[];
    var plotstore=[];
    var filesStorage=[]
    let panelCount = 0;
    const maxPanels = 5; // Maximum number of panels allowed
    const textboxesConfig = {
        'DC_Potential': ["Frequency (Hz)", "Amplitude (mV)",'Start potential (V)', 'Switch potential (V)', 'Scan rate (V s<sup>-1</sup>)' ],
        'Time': ["Frequency (Hz)", "Amplitude (mV)"],
        "Potential":["Frequency (Hz)", "Amplitude (mV)"]
        
    };
    
    const labeldict={"Frequency (Hz)":"freq", "Amplitude (mV)":"amp",'Start potential (V)':"estart", 'Switch potential (V)':"ereverse", 'Scan rate (V s<sup>-1</sup>)':"v"}
    const invlabeldict=Object.entries(labeldict).reduce((reversedObj, [key, value]) => {
        reversedObj[value] = key;
        return reversedObj;
    }, {});
    
    const fromSlider = document.querySelector('#fromSlider');
    const toSlider = document.querySelector('#toSlider');
    const fromInput = document.querySelector('#fromInput');
    const toInput = document.querySelector('#toInput');
    fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider);
    setToggleAccessible(toSlider);

    fromSlider.oninput = () => controlFromSlider(fromSlider, toSlider, fromInput);
    toSlider.oninput = () => controlToSlider(fromSlider, toSlider, toInput);
    fromInput.oninput = () => controlFromInput(fromSlider, fromInput, toInput, toSlider);
    toInput.oninput = () => controlToInput(toSlider, fromInput, toInput, toSlider);
    // Initialize the global options when the DOM is fully loaded
    function savecsvbutton(){
        const csvbox=document.getElementById("csvcheckbox")
        const csvbutton=document.getElementById("csvsave")
        if (csvbox.checked===true){
            plot()
            csvbutton.style.visibility="visible";
            
            
        }
        else{
            csvbutton.style.visibility="hidden";
        }
            
    }
    function updateParameters() {
        const xaxis = document.getElementById('xaxis').value;
        const options = textboxesConfig[xaxis] || [];
        if (xaxis==="DC_Potential"){
            if (document.getElementById("ShowDC")===null){
                const ddown=document.getElementById("ddown");
                const label = document.createElement('label');
                label.innerHTML = "Plot DC potential";
                label.id="ShowDCLabel"
                const box = document.createElement('input');
                box.type="checkbox";
                box.id="ShowDC"
                box.checked=true;
                ddown.appendChild(label);
                ddown.appendChild(box);
            }
           
        }else{

            const elem=document.getElementById("ShowDC")
            if (elem!=null){
                elem.remove();
                document.getElementById("ShowDCLabel").remove();

            }
        }
        
        // Update existing panels with new textboxes
        const panels = document.querySelectorAll('#file-panels .panel');
        panels.forEach((panel, panelIndex) => {
            const textboxesContainer = panel.querySelector('.textboxes-container');
            textboxesContainer.innerHTML = ''; // Clear existing textboxes

            options.forEach((textboxLabel) => {
            const label = document.createElement('label');
            label.innerHTML = textboxLabel;

            const input = document.createElement('input');
            input.type = 'text';
            input.style.width = '40px';
            input.style.marginBottom = '10px';
            input.style.marginRight = '5px';
            input.style.marginLeft = '5px';

            // Assign a unique ID to the input
            input.id = `panel-${panelIndex + 1}-textbox-${labeldict[textboxLabel]}`;
            textboxesContainer.appendChild(label);
            textboxesContainer.appendChild(input);
            });
        });
    }
document.addEventListener('DOMContentLoaded', function() {
            const xaxis = document.getElementById('xaxis');
    
            // Set default value
            xaxis.value = 'Time';
            updateParameters();
            savecsvbutton();
        });      
       
    

</script>


<script type="module">
await init('./biquad_wasm_bg.wasm');
import init, * as wasm from './biquad_wasm.js';
window.plot = plot;
window.saveallplot=saveallplot;
window.savecsv=savecsv;


</script>
</html>
